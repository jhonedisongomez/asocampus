<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">

<dom-module id="sign-up">

    <template>

    <div style="margin-top: 140px;">
       <paper-material elevation="3" style="max-width: 380px;
        margin-left: 31%;
        padding: 50px;
        background: white;
        margin: 0 auto;">

            <div id="sign-up" style="padding:10%;">

                <form is="iron-form"id="sign-up-form">

                    <paper-input required auto-validate error-message="no se permite espacios en blanco" id="name"
                               label="Nombres" required></paper-input>

                    <paper-input required auto-validate error-message="no se permite espacios en blanco" id="lastName"
                               label="Apellidos" required></paper-input>

                    <paper-input required auto-validate error-message="no se permite espacios en blanco" id="email"
                               label="Correo electronico" required></paper-input>

                    <paper-input required auto-validate error-message="no se permite espacios en blanco" id="password"
                               label="Contraseña" type="password" required style="margin-top: 13px;"></paper-input>

                    <paper-input required auto-validate error-message="no se permite espacios en blanco" id="confirmPassword" label="Confirmar contraseña" type="password" required style="margin-top: 13px;"></paper-input>

                  <paper-button on-click="signUp" raised style="width: 100%;margin-top: 23px;background: #7eb43e;
                      color: white;" >Registrarse</paper-button>
                </form>

            </div>
        </paper-material>

    </div>

        <iron-ajax
          id="ajax"
          url=""
          handle-as="json"
          on-response="hresponse"
          debounce-duration="300">
        </iron-ajax>

        <iron-ajax
          id="signUp"
          url=""
          handle-as="json"
          contentType="application/x-www-form-urlencoded; charset=UTF-8"
          on-response="signUpResponse"
          debounce-duration="300">
        </iron-ajax>

        <paper-dialog entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation" id="dialog"
                        modal = "true">
            <h2>Mensaje</h2>
            <div id="dialog-body">Dialog body</div>
            <div class="buttons">
                <paper-button dialog-dismiss>Cerrar</paper-button>

            </div>

        </paper-dialog>
    </template>

    <script >

    Polymer({
        is: 'sign-up',
        signUp: function(event){

            if(this.$.name.validate() && this.$.password.validate() && this.$.lastName.validate()
                && this.$.email.validate() && this.$.password.validate() && this.$.confirmPassword.validate()){

                if(this.$.password.value == this.$.confirmPassword.value){
                    this.$.ajax.url = '/registro/'
                    this.$.ajax.params = {'email':this.$.email.value};

                    this.$.ajax.generateRequest();

                }else{
                    document.getElementById("dialog-body").innerHTML = "las contraseñas no son iguales";
                    this.$.dialog.open();

                }

            }else{
                document.getElementById("dialog-body").innerHTML = "los valores no son validos";
                this.$.dialog.open();

            }
        },
        hresponse: function(request) {

            if(!request.detail.response.is_error){
                if(request.detail.response.exist){

                document.getElementById("dialog-body").innerHTML = request.detail.response.message;
                this.$.dialog.open();

                }else{
                    var csrftoken = document.getElementById("csrfmiddlewaretoken").value;
                    this.$.signUp.method = "POST";
                    this.$.signUp.url = '/registro/';
                    
                    this.$.signUp.body = {'password': this.$.password.value,
                        'email': this.$.email.value,
                        'name':this.$.name.value,
                        'last_name': this.$.lastName.value,};

                    this.$.signUp.headers = {
                        "X-CSRFToken":  getCookie('csrftoken'),
                        "X-Requested-With": "XMLHttpRequest",
                        "content-type": "application/json"
                    };


                    this.$.signUp.generateRequest();
                }

            }else{
                document.getElementById("dialog-body").innerHTML = request.detail.response.message;
                this.$.dialog.open();
            }
        },

        signUpResponse: function(request){

            if(!request.detail.response.is_error){
                this.$.name.value = "";
                this.$.password.value = "";
                this.$.lastName.value = "";
                this.$.email.value = "";
                this.$.confirmPassword.value = "";

                document.getElementById("dialog-body").innerHTML = request.detail.response.message;
                this.$.dialog.open();
            }else{

                document.getElementById("dialog-body").innerHTML = request.detail.response.message;
                this.$.dialog.open();
            }

        }

    });

    </script>


</dom-module>
